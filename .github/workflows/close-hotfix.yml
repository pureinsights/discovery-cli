name: Close Hotfix

on:
  workflow_dispatch:

concurrency:
  group: release

env:
  GITHUB_PACKAGE_REGISTRY_USER: ${{ secrets.CI_USER }}
  GITHUB_PACKAGE_REGISTRY_API_KEY: ${{ secrets.CI_TOKEN }}
  CI_SIGNING_KEY: ${{ secrets.CI_SIGNING_KEY }}

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      release-version: ${{ steps.define-version.outputs.release-version }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set execution permissions
        run: |
          chmod +x ./gradlew
          ./gradlew ciTools
          chmod -R +x ci-tools

      - name: Define version
        id: define-version
        run: |
          ./gradlew -Dversion.prerelease="" -Dversion.buildmeta=""
          
          releaseVersion=$(ci-tools/read-version.sh)
          echo "Configuring version for Release ${releaseVersion}"
          echo "release-version=${releaseVersion}" >> $GITHUB_OUTPUT

  validate:
    needs: version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set execution permissions
        run: |
          chmod +x ./gradlew
          ./gradlew ciTools
          chmod -R +x ci-tools

      - name: Validate branch
        env:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
        run: ci-tools/validate-hotfix-branch.sh

      - name: Validate release number
        env:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
        run: ci-tools/validate-release-version.sh -v ${{ needs.version.outputs.release-version }}

      - name: Find snapshots
        run: ci-tools/find-snapshots.sh

  cli-banner:
    needs:
      - validate
      - version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}
          token: ${{ secrets.CI_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set execution permissions
        run: |
          chmod +x ./gradlew
          ./gradlew ciTools
          chmod -R +x ci-tools

      - name: Create the PDP Banner for the CLI
        run: |
          ./gradlew -Dversion.semver="${{ needs.version.outputs.release-version }}"
          ./gradlew banner

      - name: Renaming the banner
        run: mv ./build/resources/main/micronaut-banner.txt ./build/resources/main/banner.txt

      - name: Uploading the CLI banner
        uses: actions/upload-artifact@master
        with:
          name: cli-banner-${{ needs.version.outputs.release-version }}
          path: ./build/resources/main/banner.txt

  windows-build:
    needs:
      - version
      - cli-banner
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}
          token: ${{ secrets.CI_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Downloading the cli banner
        uses: actions/download-artifact@master
        with:
          name: cli-banner-${{ needs.version.outputs.release-version }}
          path: ./build/resources/main/

      - name: Run unit tests
        run: tox -e py

      - name: Build executable with pyinstaller
        run: |
          pyinstaller `
            ./src/pdp.py `
            --collect-all yaspin -y `
            --add-data "src/templates;templates" `
            --add-data "build/resources/main/banner.txt;."

      - name: Zip dist folder
        run: |
          cd ./dist/
          7z a -tzip pdp-cli-${{ needs.version.outputs.release-version }}-${{ runner.os }}.zip ./pdp

      - uses: actions/upload-artifact@master
        with:
          name: pdp-cli-${{ needs.version.outputs.release-version }}-${{ runner.os }}
          path: ./dist/pdp-cli-${{ needs.version.outputs.release-version }}-${{ runner.os }}.zip

  linux-build:
    needs:
      - version
      - cli-banner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}
          token: ${{ secrets.CI_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Downloading the cli banner
        uses: actions/download-artifact@master
        with:
          name: cli-banner-${{ needs.version.outputs.release-version }}
          path: ./build/resources/main/

      - name: Run unit tests
        run: tox -e py

      - name: Build executable with pyinstaller
        run: |
          pyinstaller \
            ./src/pdp.py \
            --collect-all yaspin -y \
            --add-data "src/templates:templates" \
            --add-data "build/resources/main/banner.txt:."

      - name: Zip dist folder
        run: |
          cd ./dist/
          tar -czf pdp-cli-${{ needs.version.outputs.release-version }}-${{ runner.os }}.tar.gz  ./pdp

      - uses: actions/upload-artifact@master
        with:
          name: pdp-cli-${{ needs.version.outputs.release-version }}-${{ runner.os }}
          path: ./dist/pdp-cli-${{ needs.version.outputs.release-version }}-${{ runner.os }}.tar.gz

  tag-release:
    needs:
      - version
      - linux-build
      - windows-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v3
        with:
          ref: ${{ needs.build.outputs.branch-ref }}
          token: ${{ secrets.CI_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set execution permissions
        run: |
          chmod +x ./gradlew
          ./gradlew ciTools
          chmod -R +x ci-tools

      - name: Commit version
        id: commit-version
        run: ci-tools/commit-release-version.sh -v ${{ needs.version.outputs.release-version }}

      - name: Release Notes
        id: release-notes
        uses: mikepenz/release-changelog-builder-action@v3.4.0
        env:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
        with:
          configuration: "ci-tools/release-notes.json"
          fromTag: f040320e74d2cee69026c4b6f7ef8ef04e78ed54
          toTag: 836278b993329d4374c6264bf95bc9be0bd12586

      - name: Tag and publish the release
        env:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          ci-tools/publish-release.sh \
            -v "${{ needs.version.outputs.release-version }}" \
            -n "${{ steps.release-notes.outputs.changelog }}"

      - name: Downloading linux binaries
        uses: actions/download-artifact@master
        with:
          name: pdp-cli-${{ needs.version.outputs.release-version }}-Linux
          path: ./dist

      - name: Downloading windows binaries
        uses: actions/download-artifact@master
        with:
          name: pdp-cli-${{ needs.version.outputs.release-version }}-Windows
          path: ./dist

      - name: Upload binaries
        env:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          gh release upload ${{ needs.version.outputs.release-version }} ./dist/pdp-cli-${{ needs.version.outputs.release-version }}-Windows.zip
          gh release upload ${{ needs.version.outputs.release-version }} ./dist/pdp-cli-${{ needs.version.outputs.release-version }}-Linux.tar.gz
  

  merge-to-develop:
    needs:
      - version
      - linux-build
      - windows-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CI_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set execution permissions
        run: |
          chmod +x ./gradlew
          ./gradlew ciTools
          chmod -R +x ci-tools

      - name: Create PR with changes
        env:
          GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          . ci-tools/config-branches.sh
          ci-tools/merge-pull-request.sh -f \
            -s "${{ github.ref_name }}" \
            -t "${DEVELOP_BRANCH}" \
            -i "${{ github.run_id }}"

  artifacts-cleanup:
    needs:
      - tag-release
      - linux-build
      - windows-build
      - cli-banner
      - version
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Clean up artifacts
        uses: geekyeggo/delete-artifact@v2
        with:
          name: |
            pdp-cli-${{ needs.version.outputs.release-version }}-Windows
            pdp-cli-${{ needs.version.outputs.release-version }}-Linux
            cli-banner-${{ needs.version.outputs.release-version }}
          failOnError: false