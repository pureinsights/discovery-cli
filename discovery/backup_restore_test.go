package discovery

import (
	"fmt"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/pureinsights/pdp-cli/internal/fileutils"
	"github.com/pureinsights/pdp-cli/internal/testutils"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"github.com/tidwall/gjson"
)

// Test_backupRestoreImport has table-driven tests to test the Import method.
func Test_backupRestoreImport(t *testing.T) {
	bytes := []byte{80, 75, 3, 4, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 80, 114, 111, 99, 101, 115, 115, 111, 114, 46, 110, 100, 106, 115, 111, 110, 213, 149, 77, 111, 19, 49, 16, 134, 239, 72, 252, 135, 104, 169, 4, 72, 177, 176, 189, 246, 218, 206, 173, 8, 9, 113, 64, 72, 40, 92, 64, 28, 252, 49, 219, 90, 221, 47, 237, 58, 165, 85, 148, 255, 206, 236, 38, 77, 26, 181, 148, 246, 64, 37, 78, 201, 206, 188, 182, 103, 222, 199, 31, 235, 44, 93, 119, 144, 45, 178, 4, 117, 87, 217, 4, 217, 60, 107, 108, 61, 70, 150, 187, 200, 172, 235, 91, 15, 195, 208, 246, 152, 171, 172, 131, 106, 200, 22, 63, 126, 206, 51, 235, 83, 188, 68, 101, 234, 87, 48, 207, 98, 192, 49, 146, 21, 65, 88, 109, 9, 104, 11, 68, 104, 237, 137, 129, 92, 145, 32, 149, 40, 172, 161, 74, 72, 129, 179, 248, 30, 108, 138, 109, 179, 140, 53, 12, 201, 214, 29, 14, 229, 148, 75, 66, 53, 225, 108, 201, 217, 66, 242, 5, 229, 223, 167, 5, 135, 244, 173, 11, 88, 71, 120, 132, 218, 183, 77, 25, 207, 178, 197, 122, 42, 174, 109, 80, 185, 171, 30, 147, 46, 54, 33, 54, 103, 195, 152, 78, 49, 85, 99, 147, 175, 214, 51, 156, 219, 190, 121, 253, 110, 138, 188, 126, 59, 219, 160, 50, 192, 224, 251, 216, 237, 102, 56, 104, 110, 197, 39, 229, 102, 126, 240, 109, 145, 157, 172, 167, 57, 54, 139, 217, 201, 250, 150, 18, 101, 155, 151, 47, 214, 127, 54, 58, 97, 87, 4, 174, 186, 182, 79, 143, 112, 88, 4, 224, 69, 96, 132, 82, 97, 137, 40, 157, 33, 38, 40, 71, 10, 106, 164, 215, 133, 21, 212, 132, 191, 57, 44, 151, 204, 140, 158, 229, 234, 49, 14, 31, 171, 255, 3, 135, 219, 14, 26, 27, 15, 254, 126, 193, 239, 211, 79, 79, 217, 198, 202, 49, 195, 193, 50, 98, 189, 200, 137, 200, 141, 35, 38, 55, 5, 145, 64, 57, 47, 53, 43, 185, 119, 207, 179, 141, 99, 211, 173, 210, 145, 67, 152, 75, 208, 164, 157, 143, 117, 27, 160, 154, 246, 208, 21, 238, 161, 218, 65, 24, 1, 144, 156, 12, 181, 173, 170, 108, 126, 160, 180, 79, 14, 163, 169, 3, 244, 151, 208, 79, 43, 76, 13, 11, 22, 74, 161, 128, 112, 170, 75, 34, 148, 103, 68, 51, 94, 18, 153, 123, 95, 112, 175, 120, 97, 203, 109, 195, 1, 215, 142, 118, 92, 210, 56, 160, 80, 96, 253, 86, 50, 74, 68, 225, 37, 142, 201, 241, 95, 174, 53, 207, 75, 45, 140, 231, 199, 96, 234, 182, 57, 107, 15, 92, 62, 143, 159, 31, 222, 207, 190, 158, 126, 124, 10, 28, 173, 130, 150, 150, 9, 82, 58, 166, 240, 142, 49, 134, 104, 23, 240, 162, 41, 61, 119, 204, 113, 173, 165, 122, 30, 56, 35, 145, 241, 119, 135, 228, 1, 76, 123, 243, 143, 52, 219, 141, 186, 147, 244, 80, 66, 15, 141, 63, 62, 51, 251, 232, 205, 105, 216, 243, 116, 171, 234, 98, 60, 72, 168, 115, 118, 152, 238, 145, 85, 106, 123, 100, 51, 76, 69, 86, 21, 220, 72, 127, 197, 139, 120, 31, 245, 178, 48, 146, 230, 92, 145, 156, 41, 73, 132, 53, 26, 89, 42, 74, 10, 169, 67, 169, 37, 23, 92, 216, 59, 212, 113, 53, 4, 175, 9, 117, 74, 32, 117, 197, 137, 115, 202, 19, 80, 86, 115, 174, 2, 222, 255, 254, 81, 212, 7, 44, 246, 73, 111, 139, 181, 148, 233, 162, 100, 4, 159, 18, 220, 163, 142, 83, 130, 184, 41, 22, 159, 187, 160, 12, 40, 237, 244, 243, 114, 175, 98, 115, 241, 0, 45, 236, 98, 149, 206, 177, 181, 219, 146, 109, 104, 151, 63, 7, 27, 224, 56, 191, 13, 221, 161, 125, 126, 29, 250, 237, 163, 113, 11, 120, 183, 234, 33, 54, 67, 60, 59, 79, 119, 152, 187, 170, 189, 247, 164, 255, 83, 230, 191, 1, 80, 75, 7, 8, 192, 218, 228, 80, 171, 2, 0, 0, 78, 8, 0, 0, 80, 75, 3, 4, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 0, 80, 105, 112, 101, 108, 105, 110, 101, 46, 110, 100, 106, 115, 111, 110, 221, 146, 77, 107, 220, 48, 16, 134, 239, 133, 254, 135, 162, 179, 5, 214, 215, 74, 218, 219, 82, 72, 41, 180, 16, 146, 244, 210, 146, 195, 72, 30, 101, 5, 94, 219, 200, 218, 210, 101, 217, 255, 222, 217, 108, 147, 77, 82, 10, 233, 165, 135, 250, 226, 177, 231, 121, 231, 67, 122, 247, 108, 128, 13, 178, 37, 187, 90, 125, 120, 55, 229, 9, 251, 60, 32, 107, 88, 15, 1, 251, 153, 45, 191, 221, 54, 12, 98, 205, 223, 137, 169, 101, 139, 13, 203, 29, 209, 46, 9, 133, 128, 154, 91, 5, 134, 107, 19, 61, 247, 82, 121, 110, 162, 240, 126, 17, 91, 101, 93, 162, 42, 177, 32, 212, 60, 14, 55, 121, 131, 115, 133, 205, 68, 82, 217, 74, 195, 91, 199, 165, 184, 145, 98, 105, 228, 178, 149, 95, 239, 27, 206, 245, 203, 212, 65, 197, 238, 21, 116, 30, 114, 205, 208, 95, 87, 226, 137, 42, 112, 119, 10, 27, 54, 31, 223, 52, 248, 254, 252, 147, 226, 186, 155, 142, 220, 84, 198, 136, 243, 60, 22, 2, 31, 227, 227, 150, 251, 211, 90, 54, 8, 47, 17, 4, 135, 168, 21, 215, 202, 7, 238, 149, 95, 112, 131, 173, 148, 201, 137, 36, 99, 96, 207, 15, 228, 208, 252, 210, 58, 219, 57, 3, 66, 243, 20, 132, 229, 218, 121, 207, 93, 232, 34, 247, 41, 202, 32, 130, 116, 206, 216, 151, 218, 219, 195, 161, 97, 5, 227, 88, 186, 203, 177, 207, 113, 119, 156, 53, 159, 227, 251, 108, 45, 187, 115, 242, 249, 93, 108, 224, 199, 21, 229, 243, 113, 97, 69, 112, 165, 147, 27, 183, 245, 140, 159, 106, 211, 116, 151, 55, 226, 51, 35, 2, 75, 25, 203, 67, 158, 93, 172, 62, 126, 162, 153, 72, 18, 198, 237, 240, 100, 134, 0, 53, 174, 207, 159, 212, 231, 61, 1, 149, 45, 165, 105, 88, 234, 183, 243, 122, 149, 42, 150, 199, 194, 244, 188, 125, 179, 127, 240, 210, 53, 66, 137, 235, 191, 176, 147, 7, 171, 67, 82, 192, 49, 72, 160, 115, 87, 154, 7, 215, 42, 30, 189, 12, 73, 132, 168, 77, 194, 127, 104, 167, 60, 220, 145, 130, 26, 253, 110, 170, 23, 169, 215, 91, 203, 136, 69, 167, 193, 209, 138, 14, 144, 236, 225, 200, 25, 168, 44, 239, 140, 213, 11, 240, 173, 213, 70, 159, 174, 98, 218, 214, 139, 140, 253, 81, 180, 70, 232, 176, 252, 201, 113, 0, 173, 112, 139, 36, 56, 85, 72, 92, 7, 217, 114, 50, 90, 203, 149, 80, 161, 179, 30, 173, 11, 238, 255, 118, 220, 79, 80, 75, 7, 8, 113, 58, 49, 90, 207, 1, 0, 0, 190, 4, 0, 0, 80, 75, 3, 4, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 83, 101, 101, 100, 46, 110, 100, 106, 115, 111, 110, 205, 81, 77, 107, 220, 48, 16, 189, 23, 250, 31, 138, 206, 22, 216, 250, 88, 75, 190, 45, 129, 164, 135, 22, 66, 179, 189, 52, 244, 32, 141, 71, 187, 34, 94, 203, 200, 114, 155, 176, 228, 191, 119, 156, 18, 182, 20, 2, 185, 37, 58, 141, 230, 189, 153, 247, 134, 119, 98, 229, 97, 66, 214, 177, 185, 184, 125, 28, 247, 172, 98, 163, 59, 174, 141, 27, 116, 25, 14, 159, 102, 196, 158, 154, 131, 243, 56, 204, 172, 187, 253, 89, 49, 7, 37, 254, 34, 74, 201, 11, 86, 44, 246, 68, 22, 14, 250, 218, 109, 26, 110, 180, 0, 174, 130, 52, 220, 5, 225, 185, 5, 163, 176, 209, 194, 180, 18, 105, 11, 100, 116, 37, 166, 113, 23, 143, 72, 130, 199, 105, 29, 173, 133, 230, 181, 225, 162, 217, 137, 166, 211, 162, 171, 229, 143, 39, 193, 185, 124, 159, 122, 87, 176, 127, 5, 27, 210, 24, 226, 158, 117, 167, 39, 115, 105, 92, 15, 130, 156, 134, 129, 48, 191, 192, 29, 22, 234, 248, 33, 237, 103, 246, 88, 177, 41, 78, 56, 196, 113, 189, 210, 186, 86, 249, 32, 29, 71, 47, 28, 87, 82, 42, 238, 77, 45, 57, 88, 225, 67, 227, 65, 233, 176, 26, 207, 8, 41, 247, 215, 105, 136, 240, 176, 170, 96, 206, 41, 63, 127, 217, 229, 118, 183, 253, 66, 172, 66, 70, 211, 82, 206, 180, 153, 138, 85, 229, 122, 215, 124, 94, 133, 9, 244, 105, 25, 255, 89, 20, 207, 53, 225, 222, 21, 56, 156, 193, 163, 187, 191, 32, 58, 121, 23, 186, 98, 97, 88, 230, 195, 54, 20, 204, 127, 55, 126, 101, 143, 244, 62, 126, 56, 189, 24, 225, 183, 237, 213, 43, 243, 147, 117, 128, 77, 111, 45, 7, 244, 45, 167, 163, 21, 183, 38, 88, 46, 90, 172, 13, 232, 32, 122, 5, 111, 158, 223, 239, 120, 23, 255, 207, 207, 132, 70, 162, 67, 197, 91, 233, 52, 25, 7, 203, 173, 144, 150, 107, 104, 172, 221, 64, 45, 91, 19, 222, 121, 126, 127, 0, 80, 75, 7, 8, 144, 154, 248, 251, 112, 1, 0, 0, 131, 3, 0, 0, 80, 75, 3, 4, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 0, 0, 0, 83, 101, 101, 100, 83, 99, 104, 101, 100, 117, 108, 101, 46, 110, 100, 106, 115, 111, 110, 117, 80, 187, 78, 196, 48, 16, 236, 145, 248, 135, 104, 75, 20, 75, 246, 198, 78, 76, 62, 128, 234, 202, 92, 3, 186, 194, 177, 55, 135, 165, 60, 172, 216, 135, 64, 81, 254, 29, 7, 132, 160, 65, 91, 141, 102, 118, 118, 102, 55, 152, 205, 68, 208, 66, 63, 46, 215, 88, 68, 251, 74, 206, 221, 70, 130, 18, 28, 69, 187, 250, 144, 252, 50, 103, 254, 47, 42, 97, 52, 61, 141, 17, 218, 151, 75, 9, 198, 38, 255, 150, 45, 210, 122, 163, 18, 188, 203, 98, 106, 68, 47, 16, 45, 115, 110, 24, 152, 172, 120, 205, 180, 236, 13, 35, 172, 184, 194, 198, 73, 169, 108, 118, 177, 43, 153, 195, 176, 243, 19, 197, 100, 166, 144, 87, 145, 163, 98, 92, 51, 84, 157, 168, 91, 196, 86, 241, 231, 175, 131, 49, 157, 131, 51, 137, 220, 255, 106, 217, 180, 168, 14, 53, 189, 135, 149, 98, 252, 78, 46, 120, 33, 100, 241, 144, 71, 100, 42, 18, 185, 35, 248, 6, 97, 93, 2, 173, 201, 83, 134, 219, 158, 25, 107, 230, 238, 35, 28, 207, 120, 58, 159, 78, 240, 219, 108, 48, 99, 252, 169, 134, 198, 58, 110, 106, 193, 180, 202, 253, 228, 80, 105, 102, 6, 236, 217, 163, 213, 146, 132, 66, 221, 84, 4, 251, 101, 191, 191, 251, 4, 80, 75, 7, 8, 70, 19, 66, 76, 240, 0, 0, 0, 91, 1, 0, 0, 80, 75, 1, 2, 20, 0, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 192, 218, 228, 80, 171, 2, 0, 0, 78, 8, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 80, 114, 111, 99, 101, 115, 115, 111, 114, 46, 110, 100, 106, 115, 111, 110, 80, 75, 1, 2, 20, 0, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 113, 58, 49, 90, 207, 1, 0, 0, 190, 4, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 233, 2, 0, 0, 80, 105, 112, 101, 108, 105, 110, 101, 46, 110, 100, 106, 115, 111, 110, 80, 75, 1, 2, 20, 0, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 144, 154, 248, 251, 112, 1, 0, 0, 131, 3, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 245, 4, 0, 0, 83, 101, 101, 100, 46, 110, 100, 106, 115, 111, 110, 80, 75, 1, 2, 20, 0, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 70, 19, 66, 76, 240, 0, 0, 0, 91, 1, 0, 0, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 158, 6, 0, 0, 83, 101, 101, 100, 83, 99, 104, 101, 100, 117, 108, 101, 46, 110, 100, 106, 115, 111, 110, 80, 75, 5, 6, 0, 0, 0, 0, 4, 0, 4, 0, 245, 0, 0, 0, 207, 7, 0, 0, 0, 0}
	tests := []struct {
		name          string
		method        string
		path          string
		subClientPath string
		statusCode    int
		response      []byte
		testFunc      func(t *testing.T, b backupRestore)
	}{
		// Working cases
		{
			name:          "Restore restores the entities with on conflict update.",
			method:        http.MethodPost,
			path:          "/v2/import",
			subClientPath: "/v2",
			statusCode:    http.StatusMultiStatus,
			response:      []byte(`{"Processor":[{"id":"516d4a8a-e8ae-488c-9e37-d5746a907454","status":200},{"id":"72a57085-5da9-4c96-9d6c-26b019b80a7c","status":201},{"id":"7b192ea1-ac43-439b-9396-5e022f81f2cb","status":200},{"id":"87d85a14-fb17-4899-8bdc-9fc2b1b28857","status":200},{"id":"aa0186f1-746f-4b20-b1b0-313bd79e78b8","status":200}],"Pipeline":[{"id":"8f13eae4-73a5-45c9-9239-5c1996c0378f","status":200},{"id":"9a74bf3a-eb2a-4334-b803-c92bf1bc45fe","status":200}],"Seed":[{"id":"2acd0a61-852c-4f38-af2b-9c84e152873e","status":200},{"id":"30fc6d99-ceb7-45f4-98f9-27e08c5f2d4c","status":200}],"SeedSchedule":[{"id":"e71b122c-ddff-4306-84ba-e230527d445c","status":200}]}`),
			testFunc: func(t *testing.T, b backupRestore) {
				fileName, err := fileutils.CreateTemporaryFile("", "test-export.zip", string(bytes))
				if err != nil {
					fmt.Println(err)
					return
				}
				response, err := b.Import(OnConflictUpdate, fileName)
				require.NoError(t, err)
				assert.True(t, response.Get("Processor").Exists())
				assert.True(t, response.Get("Pipeline").Exists())
				assert.True(t, response.Get("Seed").Exists())
				assert.Equal(t, int64(201), response.Get("Processor.1.status").Int())
				assert.Equal(t, int64(200), response.Get("Processor.0.status").Int())
			},
		},
		{
			name:          "Restore restores the entities with on conflict ignore.",
			method:        http.MethodPost,
			path:          "/v2/import",
			subClientPath: "/v2",
			statusCode:    http.StatusMultiStatus,
			response:      []byte(`{"Processor":[{"id":"516d4a8a-e8ae-488c-9e37-d5746a907454","status":204},{"id":"70f700c5-c70f-4036-b6ed-5e931140b715","status":201},{"id":"7b192ea1-ac43-439b-9396-5e022f81f2cb","status":204},{"id":"87d85a14-fb17-4899-8bdc-9fc2b1b28857","status":204},{"id":"aa0186f1-746f-4b20-b1b0-313bd79e78b8","status":204}],"Pipeline":[{"id":"8f13eae4-73a5-45c9-9239-5c1996c0378f","status":204},{"id":"9a74bf3a-eb2a-4334-b803-c92bf1bc45fe","status":204}],"Seed":[{"id":"2acd0a61-852c-4f38-af2b-9c84e152873e","status":204},{"id":"30fc6d99-ceb7-45f4-98f9-27e08c5f2d4c","status":204}],"SeedSchedule":[{"id":"e71b122c-ddff-4306-84ba-e230527d445c","status":204}]}`),
			testFunc: func(t *testing.T, b backupRestore) {
				fileName, err := fileutils.CreateTemporaryFile("", "test-export.zip", string(bytes))
				if err != nil {
					fmt.Println(err)
					return
				}
				response, err := b.Import(OnConflictIgnore, fileName)
				require.NoError(t, err)
				assert.True(t, response.Get("Processor").Exists())
				assert.True(t, response.Get("Pipeline").Exists())
				assert.True(t, response.Get("Seed").Exists())
				assert.Equal(t, int64(201), response.Get("Processor.1.status").Int())
				assert.Equal(t, int64(204), response.Get("Processor.0.status").Int())
			},
		},
		{
			name:          "Restore restores the entities with on conflict fail.",
			method:        http.MethodPost,
			path:          "/v2/import",
			subClientPath: "/v2",
			statusCode:    http.StatusMultiStatus,
			response:      []byte(`{"Processor":[{"id":"516d4a8a-e8ae-488c-9e37-d5746a907454","status":409,"errorCode":2001,"errors":["Duplicated entity: 516d4a8a-e8ae-488c-9e37-d5746a907454"]},{"id":"5536e705-0c5d-4711-9a99-e272b32948cb","status":201},{"id":"7b192ea1-ac43-439b-9396-5e022f81f2cb","status":409,"errorCode":2001,"errors":["Duplicated entity: 7b192ea1-ac43-439b-9396-5e022f81f2cb"]},{"id":"87d85a14-fb17-4899-8bdc-9fc2b1b28857","status":409,"errorCode":2001,"errors":["Duplicated entity: 87d85a14-fb17-4899-8bdc-9fc2b1b28857"]},{"id":"aa0186f1-746f-4b20-b1b0-313bd79e78b8","status":409,"errorCode":2001,"errors":["Duplicated entity: aa0186f1-746f-4b20-b1b0-313bd79e78b8"]}],"Pipeline":[{"id":"8f13eae4-73a5-45c9-9239-5c1996c0378f","status":409,"errorCode":2001,"errors":["Duplicated entity: 8f13eae4-73a5-45c9-9239-5c1996c0378f"]},{"id":"9a74bf3a-eb2a-4334-b803-c92bf1bc45fe","status":409,"errorCode":2001,"errors":["Duplicated entity: 9a74bf3a-eb2a-4334-b803-c92bf1bc45fe"]}],"Seed":[{"id":"2acd0a61-852c-4f38-af2b-9c84e152873e","status":409,"errorCode":2001,"errors":["Duplicated entity: 2acd0a61-852c-4f38-af2b-9c84e152873e"]},{"id":"30fc6d99-ceb7-45f4-98f9-27e08c5f2d4c","status":409,"errorCode":2001,"errors":["Duplicated entity: 30fc6d99-ceb7-45f4-98f9-27e08c5f2d4c"]}],"SeedSchedule":[{"id":"e71b122c-ddff-4306-84ba-e230527d445c","status":409,"errorCode":2001,"errors":["Duplicated entity: e71b122c-ddff-4306-84ba-e230527d445c"]}]}`),
			testFunc: func(t *testing.T, b backupRestore) {
				fileName, err := fileutils.CreateTemporaryFile("", "test-export.zip", string(bytes))
				if err != nil {
					fmt.Println(err)
					return
				}
				response, err := b.Import(OnConflictIgnore, fileName)
				require.NoError(t, err)
				assert.True(t, response.Get("Processor").Exists())
				assert.True(t, response.Get("Pipeline").Exists())
				assert.True(t, response.Get("Seed").Exists())
				assert.Equal(t, int64(201), response.Get("Processor.1.status").Int())
				assert.Equal(t, int64(409), response.Get("Processor.0.status").Int())
			},
		},

		// Error cases
		{
			name:          "Restore fails with method not allowed",
			method:        http.MethodPost,
			path:          "/v2/import",
			subClientPath: "/v2",
			statusCode:    http.StatusMethodNotAllowed,
			response: []byte(`{
				"status": 405,
				"code": 1001,
				"messages": [
					"Method [GET] not allowed for URI [/v2/import]. Allowed methods: [POST]"
				],
				"timestamp": "2025-08-25T21:09:12.607204700Z"
			}`),
			testFunc: func(t *testing.T, b backupRestore) {
				fileName, err := fileutils.CreateTemporaryFile("", "test-export.zip", string(bytes))
				if err != nil {
					fmt.Println(err)
					return
				}
				response, err := b.Import(OnConflictIgnore, fileName)
				assert.Equal(t, gjson.Result{}, response)
				assert.EqualError(t, err, fmt.Sprintf("status: %d, body: %s", http.StatusMethodNotAllowed, []byte(`{
				"status": 405,
				"code": 1001,
				"messages": [
					"Method [GET] not allowed for URI [/v2/import]. Allowed methods: [POST]"
				],
				"timestamp": "2025-08-25T21:09:12.607204700Z"
			}`)))
			},
		},
		{
			name:          "Restore fails with invalid on conflict.",
			method:        http.MethodPost,
			path:          "/v2/import",
			subClientPath: "/v2",
			statusCode:    http.StatusBadRequest,
			response:      []byte(`{"status":400,"code":3002,"messages":["Failed to convert argument [onConflict] for value "test" due to: No enum constant com.pureinsights.pdp.core.data.backup.ImportOptions.ConflictResolutionStrategy.test"],"timestamp":"2025-08-25T19:48:41.068729500Z"}`),
			testFunc: func(t *testing.T, b backupRestore) {
				fileName, _ := fileutils.CreateTemporaryFile("", "test-export.zip", string(bytes))
				response, err := b.Import("test", fileName)
				require.Error(t, err)
				assert.Equal(t, gjson.Result{}, response)
				errorStruct := err.(Error)
				assert.Equal(t, 400, errorStruct.Status)
				assert.Contains(t, errorStruct.Body.Raw, "onConflict")
			},
		},
	}

	for _, tc := range tests {
		t.Run(tc.name, func(t *testing.T) {
			srv := httptest.NewServer(
				testutils.HttpHandler(t, tc.statusCode, "application/json", string(tc.response), func(t *testing.T, r *http.Request) {
					assert.Equal(t, tc.method, r.Method)
					assert.Equal(t, tc.path, r.URL.Path)
				}))
			defer srv.Close()

			s := backupRestore{client: newClient(srv.URL+tc.subClientPath, "")}
			tc.testFunc(t, s)
		})
	}
}

func Test_backupRestoreExport(t *testing.T) {
	bytes := []byte{80, 75, 3, 4, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 80, 114, 111, 99, 101, 115, 115, 111, 114, 46, 110, 100, 106, 115, 111, 110, 213, 149, 77, 111, 19, 49, 16, 134, 239, 72, 252, 135, 104, 169, 4, 72, 177, 176, 189, 246, 218, 206, 173, 8, 9, 113, 64, 72, 40, 92, 64, 28, 252, 49, 219, 90, 221, 47, 237, 58, 165, 85, 148, 255, 206, 236, 38, 77, 26, 181, 148, 246, 64, 37, 78, 201, 206, 188, 182, 103, 222, 199, 31, 235, 44, 93, 119, 144, 45, 178, 4, 117, 87, 217, 4, 217, 60, 107, 108, 61, 70, 150, 187, 200, 172, 235, 91, 15, 195, 208, 246, 152, 171, 172, 131, 106, 200, 22, 63, 126, 206, 51, 235, 83, 188, 68, 101, 234, 87, 48, 207, 98, 192, 49, 146, 21, 65, 88, 109, 9, 104, 11, 68, 104, 237, 137, 129, 92, 145, 32, 149, 40, 172, 161, 74, 72, 129, 179, 248, 30, 108, 138, 109, 179, 140, 53, 12, 201, 214, 29, 14, 229, 148, 75, 66, 53, 225, 108, 201, 217, 66, 242, 5, 229, 223, 167, 5, 135, 244, 173, 11, 88, 71, 120, 132, 218, 183, 77, 25, 207, 178, 197, 122, 42, 174, 109, 80, 185, 171, 30, 147, 46, 54, 33, 54, 103, 195, 152, 78, 49, 85, 99, 147, 175, 214, 51, 156, 219, 190, 121, 253, 110, 138, 188, 126, 59, 219, 160, 50, 192, 224, 251, 216, 237, 102, 56, 104, 110, 197, 39, 229, 102, 126, 240, 109, 145, 157, 172, 167, 57, 54, 139, 217, 201, 250, 150, 18, 101, 155, 151, 47, 214, 127, 54, 58, 97, 87, 4, 174, 186, 182, 79, 143, 112, 88, 4, 224, 69, 96, 132, 82, 97, 137, 40, 157, 33, 38, 40, 71, 10, 106, 164, 215, 133, 21, 212, 132, 191, 57, 44, 151, 204, 140, 158, 229, 234, 49, 14, 31, 171, 255, 3, 135, 219, 14, 26, 27, 15, 254, 126, 193, 239, 211, 79, 79, 217, 198, 202, 49, 195, 193, 50, 98, 189, 200, 137, 200, 141, 35, 38, 55, 5, 145, 64, 57, 47, 53, 43, 185, 119, 207, 179, 141, 99, 211, 173, 210, 145, 67, 152, 75, 208, 164, 157, 143, 117, 27, 160, 154, 246, 208, 21, 238, 161, 218, 65, 24, 1, 144, 156, 12, 181, 173, 170, 108, 126, 160, 180, 79, 14, 163, 169, 3, 244, 151, 208, 79, 43, 76, 13, 11, 22, 74, 161, 128, 112, 170, 75, 34, 148, 103, 68, 51, 94, 18, 153, 123, 95, 112, 175, 120, 97, 203, 109, 195, 1, 215, 142, 118, 92, 210, 56, 160, 80, 96, 253, 86, 50, 74, 68, 225, 37, 142, 201, 241, 95, 174, 53, 207, 75, 45, 140, 231, 199, 96, 234, 182, 57, 107, 15, 92, 62, 143, 159, 31, 222, 207, 190, 158, 126, 124, 10, 28, 173, 130, 150, 150, 9, 82, 58, 166, 240, 142, 49, 134, 104, 23, 240, 162, 41, 61, 119, 204, 113, 173, 165, 122, 30, 56, 35, 145, 241, 119, 135, 228, 1, 76, 123, 243, 143, 52, 219, 141, 186, 147, 244, 80, 66, 15, 141, 63, 62, 51, 251, 232, 205, 105, 216, 243, 116, 171, 234, 98, 60, 72, 168, 115, 118, 152, 238, 145, 85, 106, 123, 100, 51, 76, 69, 86, 21, 220, 72, 127, 197, 139, 120, 31, 245, 178, 48, 146, 230, 92, 145, 156, 41, 73, 132, 53, 26, 89, 42, 74, 10, 169, 67, 169, 37, 23, 92, 216, 59, 212, 113, 53, 4, 175, 9, 117, 74, 32, 117, 197, 137, 115, 202, 19, 80, 86, 115, 174, 2, 222, 255, 254, 81, 212, 7, 44, 246, 73, 111, 139, 181, 148, 233, 162, 100, 4, 159, 18, 220, 163, 142, 83, 130, 184, 41, 22, 159, 187, 160, 12, 40, 237, 244, 243, 114, 175, 98, 115, 241, 0, 45, 236, 98, 149, 206, 177, 181, 219, 146, 109, 104, 151, 63, 7, 27, 224, 56, 191, 13, 221, 161, 125, 126, 29, 250, 237, 163, 113, 11, 120, 183, 234, 33, 54, 67, 60, 59, 79, 119, 152, 187, 170, 189, 247, 164, 255, 83, 230, 191, 1, 80, 75, 7, 8, 192, 218, 228, 80, 171, 2, 0, 0, 78, 8, 0, 0, 80, 75, 3, 4, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 0, 80, 105, 112, 101, 108, 105, 110, 101, 46, 110, 100, 106, 115, 111, 110, 221, 146, 77, 107, 220, 48, 16, 134, 239, 133, 254, 135, 162, 179, 5, 214, 215, 74, 218, 219, 82, 72, 41, 180, 16, 146, 244, 210, 146, 195, 72, 30, 101, 5, 94, 219, 200, 218, 210, 101, 217, 255, 222, 217, 108, 147, 77, 82, 10, 233, 165, 135, 250, 226, 177, 231, 121, 231, 67, 122, 247, 108, 128, 13, 178, 37, 187, 90, 125, 120, 55, 229, 9, 251, 60, 32, 107, 88, 15, 1, 251, 153, 45, 191, 221, 54, 12, 98, 205, 223, 137, 169, 101, 139, 13, 203, 29, 209, 46, 9, 133, 128, 154, 91, 5, 134, 107, 19, 61, 247, 82, 121, 110, 162, 240, 126, 17, 91, 101, 93, 162, 42, 177, 32, 212, 60, 14, 55, 121, 131, 115, 133, 205, 68, 82, 217, 74, 195, 91, 199, 165, 184, 145, 98, 105, 228, 178, 149, 95, 239, 27, 206, 245, 203, 212, 65, 197, 238, 21, 116, 30, 114, 205, 208, 95, 87, 226, 137, 42, 112, 119, 10, 27, 54, 31, 223, 52, 248, 254, 252, 147, 226, 186, 155, 142, 220, 84, 198, 136, 243, 60, 22, 2, 31, 227, 227, 150, 251, 211, 90, 54, 8, 47, 17, 4, 135, 168, 21, 215, 202, 7, 238, 149, 95, 112, 131, 173, 148, 201, 137, 36, 99, 96, 207, 15, 228, 208, 252, 210, 58, 219, 57, 3, 66, 243, 20, 132, 229, 218, 121, 207, 93, 232, 34, 247, 41, 202, 32, 130, 116, 206, 216, 151, 218, 219, 195, 161, 97, 5, 227, 88, 186, 203, 177, 207, 113, 119, 156, 53, 159, 227, 251, 108, 45, 187, 115, 242, 249, 93, 108, 224, 199, 21, 229, 243, 113, 97, 69, 112, 165, 147, 27, 183, 245, 140, 159, 106, 211, 116, 151, 55, 226, 51, 35, 2, 75, 25, 203, 67, 158, 93, 172, 62, 126, 162, 153, 72, 18, 198, 237, 240, 100, 134, 0, 53, 174, 207, 159, 212, 231, 61, 1, 149, 45, 165, 105, 88, 234, 183, 243, 122, 149, 42, 150, 199, 194, 244, 188, 125, 179, 127, 240, 210, 53, 66, 137, 235, 191, 176, 147, 7, 171, 67, 82, 192, 49, 72, 160, 115, 87, 154, 7, 215, 42, 30, 189, 12, 73, 132, 168, 77, 194, 127, 104, 167, 60, 220, 145, 130, 26, 253, 110, 170, 23, 169, 215, 91, 203, 136, 69, 167, 193, 209, 138, 14, 144, 236, 225, 200, 25, 168, 44, 239, 140, 213, 11, 240, 173, 213, 70, 159, 174, 98, 218, 214, 139, 140, 253, 81, 180, 70, 232, 176, 252, 201, 113, 0, 173, 112, 139, 36, 56, 85, 72, 92, 7, 217, 114, 50, 90, 203, 149, 80, 161, 179, 30, 173, 11, 238, 255, 118, 220, 79, 80, 75, 7, 8, 113, 58, 49, 90, 207, 1, 0, 0, 190, 4, 0, 0, 80, 75, 3, 4, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 83, 101, 101, 100, 46, 110, 100, 106, 115, 111, 110, 205, 81, 77, 107, 220, 48, 16, 189, 23, 250, 31, 138, 206, 22, 216, 250, 88, 75, 190, 45, 129, 164, 135, 22, 66, 179, 189, 52, 244, 32, 141, 71, 187, 34, 94, 203, 200, 114, 155, 176, 228, 191, 119, 156, 18, 182, 20, 2, 185, 37, 58, 141, 230, 189, 153, 247, 134, 119, 98, 229, 97, 66, 214, 177, 185, 184, 125, 28, 247, 172, 98, 163, 59, 174, 141, 27, 116, 25, 14, 159, 102, 196, 158, 154, 131, 243, 56, 204, 172, 187, 253, 89, 49, 7, 37, 254, 34, 74, 201, 11, 86, 44, 246, 68, 22, 14, 250, 218, 109, 26, 110, 180, 0, 174, 130, 52, 220, 5, 225, 185, 5, 163, 176, 209, 194, 180, 18, 105, 11, 100, 116, 37, 166, 113, 23, 143, 72, 130, 199, 105, 29, 173, 133, 230, 181, 225, 162, 217, 137, 166, 211, 162, 171, 229, 143, 39, 193, 185, 124, 159, 122, 87, 176, 127, 5, 27, 210, 24, 226, 158, 117, 167, 39, 115, 105, 92, 15, 130, 156, 134, 129, 48, 191, 192, 29, 22, 234, 248, 33, 237, 103, 246, 88, 177, 41, 78, 56, 196, 113, 189, 210, 186, 86, 249, 32, 29, 71, 47, 28, 87, 82, 42, 238, 77, 45, 57, 88, 225, 67, 227, 65, 233, 176, 26, 207, 8, 41, 247, 215, 105, 136, 240, 176, 170, 96, 206, 41, 63, 127, 217, 229, 118, 183, 253, 66, 172, 66, 70, 211, 82, 206, 180, 153, 138, 85, 229, 122, 215, 124, 94, 133, 9, 244, 105, 25, 255, 89, 20, 207, 53, 225, 222, 21, 56, 156, 193, 163, 187, 191, 32, 58, 121, 23, 186, 98, 97, 88, 230, 195, 54, 20, 204, 127, 55, 126, 101, 143, 244, 62, 126, 56, 189, 24, 225, 183, 237, 213, 43, 243, 147, 117, 128, 77, 111, 45, 7, 244, 45, 167, 163, 21, 183, 38, 88, 46, 90, 172, 13, 232, 32, 122, 5, 111, 158, 223, 239, 120, 23, 255, 207, 207, 132, 70, 162, 67, 197, 91, 233, 52, 25, 7, 203, 173, 144, 150, 107, 104, 172, 221, 64, 45, 91, 19, 222, 121, 126, 127, 0, 80, 75, 7, 8, 144, 154, 248, 251, 112, 1, 0, 0, 131, 3, 0, 0, 80, 75, 3, 4, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 0, 0, 0, 83, 101, 101, 100, 83, 99, 104, 101, 100, 117, 108, 101, 46, 110, 100, 106, 115, 111, 110, 117, 80, 187, 78, 196, 48, 16, 236, 145, 248, 135, 104, 75, 20, 75, 246, 198, 78, 76, 62, 128, 234, 202, 92, 3, 186, 194, 177, 55, 135, 165, 60, 172, 216, 135, 64, 81, 254, 29, 7, 132, 160, 65, 91, 141, 102, 118, 118, 102, 55, 152, 205, 68, 208, 66, 63, 46, 215, 88, 68, 251, 74, 206, 221, 70, 130, 18, 28, 69, 187, 250, 144, 252, 50, 103, 254, 47, 42, 97, 52, 61, 141, 17, 218, 151, 75, 9, 198, 38, 255, 150, 45, 210, 122, 163, 18, 188, 203, 98, 106, 68, 47, 16, 45, 115, 110, 24, 152, 172, 120, 205, 180, 236, 13, 35, 172, 184, 194, 198, 73, 169, 108, 118, 177, 43, 153, 195, 176, 243, 19, 197, 100, 166, 144, 87, 145, 163, 98, 92, 51, 84, 157, 168, 91, 196, 86, 241, 231, 175, 131, 49, 157, 131, 51, 137, 220, 255, 106, 217, 180, 168, 14, 53, 189, 135, 149, 98, 252, 78, 46, 120, 33, 100, 241, 144, 71, 100, 42, 18, 185, 35, 248, 6, 97, 93, 2, 173, 201, 83, 134, 219, 158, 25, 107, 230, 238, 35, 28, 207, 120, 58, 159, 78, 240, 219, 108, 48, 99, 252, 169, 134, 198, 58, 110, 106, 193, 180, 202, 253, 228, 80, 105, 102, 6, 236, 217, 163, 213, 146, 132, 66, 221, 84, 4, 251, 101, 191, 191, 251, 4, 80, 75, 7, 8, 70, 19, 66, 76, 240, 0, 0, 0, 91, 1, 0, 0, 80, 75, 1, 2, 20, 0, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 192, 218, 228, 80, 171, 2, 0, 0, 78, 8, 0, 0, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 80, 114, 111, 99, 101, 115, 115, 111, 114, 46, 110, 100, 106, 115, 111, 110, 80, 75, 1, 2, 20, 0, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 113, 58, 49, 90, 207, 1, 0, 0, 190, 4, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 233, 2, 0, 0, 80, 105, 112, 101, 108, 105, 110, 101, 46, 110, 100, 106, 115, 111, 110, 80, 75, 1, 2, 20, 0, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 144, 154, 248, 251, 112, 1, 0, 0, 131, 3, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 245, 4, 0, 0, 83, 101, 101, 100, 46, 110, 100, 106, 115, 111, 110, 80, 75, 1, 2, 20, 0, 20, 0, 8, 8, 8, 0, 146, 110, 25, 91, 70, 19, 66, 76, 240, 0, 0, 0, 91, 1, 0, 0, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 158, 6, 0, 0, 83, 101, 101, 100, 83, 99, 104, 101, 100, 117, 108, 101, 46, 110, 100, 106, 115, 111, 110, 80, 75, 5, 6, 0, 0, 0, 0, 4, 0, 4, 0, 245, 0, 0, 0, 207, 7, 0, 0, 0, 0}
	tests := []struct {
		name          string
		method        string
		path          string
		subClientPath string
		statusCode    int
		response      []byte
		testFunc      func(t *testing.T, b backupRestore)
	}{
		// Working case
		{
			name:          "Backup exports the entities.",
			method:        http.MethodGet,
			path:          "/v2/export",
			subClientPath: "/v2",
			statusCode:    http.StatusOK,
			response:      bytes,
			testFunc: func(t *testing.T, b backupRestore) {
				response, err := b.Export()
				require.NoError(t, err)
				assert.Contains(t, string(response), "Processor.ndjson")
				assert.Contains(t, string(response), "Pipeline.ndjson")
				assert.Contains(t, string(response), "Seed.ndjson")
			},
		},

		// Error case
		{
			name:          "Backup fails",
			method:        http.MethodGet,
			path:          "/export",
			subClientPath: "/",
			statusCode:    http.StatusNotFound,
			response: []byte(`{
				"status": 404,
				"code": 1003,
				"messages": [
					"Page Not Found"
				],
				"timestamp": "2025-08-25T20:25:49.609245Z"
			}`),
			testFunc: func(t *testing.T, b backupRestore) {
				response, err := b.Export()
				assert.Equal(t, []byte{}, response)
				assert.EqualError(t, err, fmt.Sprintf("status: %d, body: %s", http.StatusNotFound, []byte(`{
				"status": 404,
				"code": 1003,
				"messages": [
					"Page Not Found"
				],
				"timestamp": "2025-08-25T20:25:49.609245Z"
			}`)))
			},
		},
	}

	for _, tc := range tests {
		t.Run(tc.name, func(t *testing.T) {
			srv := httptest.NewServer(
				testutils.HttpHandler(t, tc.statusCode, "application/json", string(tc.response), func(t *testing.T, r *http.Request) {
					assert.Equal(t, tc.method, r.Method)
					assert.Equal(t, tc.path, r.URL.Path)
				}))
			defer srv.Close()

			s := backupRestore{client: newClient(srv.URL+tc.subClientPath, "")}
			tc.testFunc(t, s)
		})
	}
}
